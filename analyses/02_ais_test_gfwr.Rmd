---
title: "Testing gfwr"
author: "Laurent Dubroca"
date: "`r format(Sys.Date(), '%d %B %Y')`"
params:
  year: 2025
output:
  rmdformats::downcute:
    lightbox: true
    toc_depth: 3
    code_folding: hide
    number_section: yes
editor_options:
  chunk_output_type: console
  markdown:
    wrap: 80
---

```{r render,echo=FALSE,eval=F}
#command to render the html outside Rstudio
here::i_am("algoabay.Rproj")
rmarkdown::render(here::here("analyses","02_ais_test_gfwr.Rmd"),output_format="html_document",clean=T)
```


```{r knitsetup,echo=FALSE}
operationnel <- TRUE
knitr::opts_chunk$set(
  warning = !operationnel,
  message = !operationnel,
  fig.width = 7,
  fig.height = 5,
  progress = !operationnel,
  verbose = !operationnel
)
```

```{r library,message = FALSE, warning=FALSE}
library(arrow)
library(here)
library(leaflet)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scattermore)
library(kableExtra)
library(sf)
library(terra)
library(tidyterra)
library(data.table)
library(skimr)
library(lubridate)
library(gfwr)

#remotes::install_github("GlobalFishingWatch/gfwr", ref = "develop", dependencies = TRUE)
#The use of gfwr requires a GFW API token, which users can request from the GFW API Portal. Save this token to your .Renviron file using usethis::edit_r_environ() and adding a variable named GFW_TOKEN to the file (GFW_TOKEN="PASTE_YOUR_TOKEN_HERE"). Save the .Renviron file and restart the R session to make the edit effective.
#need to copy ?.Renviron in the working directory
#key <- Sys.getenv("GFW_TOKEN") #should not be empty
#test
#gfw_vessel_info(query = 224224000, search_type = "search")


```

```{r setup, include=FALSE}
#here
here::i_am("algoabay.Rproj")
```

# Framework

Use of the gfwr R package to get and analyses the AIS data provided by this
platform. The main function to be tested are :

- `gfw_regions` : to get the region code of a given EEZ
- `gfw_ais_presence` : to get the AIS presence information combining all the vessels. HIGH spatial resolution, HOURLY data, by vessel_id seems to be appropriate. For now.

Data are saved locally (time request can be long and is limited by gwf). So
parquet database are created.

# Requesting AIS data

Data request + parquet creation.

```{r getgfwdata,eval=F}
#eval is F to avoid redoing data downloading : use it wisely :-)
#get SA EEZ id
#gfw_regions(region_source="EEZ")%>%filter(grepl("South Africa",label))
#id 8396
#get a list of month
dates <- seq(as.Date("2020-01-01"), as.Date("2020-12-31"), by = "month")
# Calculer le dÃ©but et la fin de chaque mois
startmonth <- floor_date(dates, "month")
endmonth<- ceiling_date(dates, "month") - 1
idmonth<-data.frame(startmonth,endmonth)
# GET AIS
#initiate a parquet db
dbpath<-here("data","raw","ais","gfw","parquet","gfw_ais_presence")
dir.create(dbpath)
ds<-open_dataset(dbpath)
#for(i in nrow(idmonth):1){
for(i in 1:1){
#	i<-36
	print(idmonth[i,])
	uu<-gfw_ais_presence(spatial_resolution = "HIGH",
			   temporal_resolution = "HOURLY",
			   #group_by = "MMSI",
			   group_by = "VESSEL_ID",
			   start_date = idmonth$startmonth[i],
			   end_date = idmonth$endmonth[i],
			   region = 8396,
			   region_source = "EEZ",
			   key = gfw_auth(),
			   print_request = TRUE)
	if(nrow(uu)>0){
		uu%>%group_by(year=year(`Time Range`),
			      month=sprintf("%02d",month(`Time Range`)))%>%
		write_dataset(path=dbpath,format="parquet")
	}
#	Sys.sleep(3) #to do not overload the gfw API -> not needed -> daily
	#	limit
}

#get vessel info : not needed. Info is in ai_presence
#listvessels<-ds%>%group_by(`Vessel ID`,`Flag`,`Vessel Name`,`Gear Type`,`Vessel Type`,MMSI,IMO,CallSign)%>%summarise(n=n())%>%collect()
#print(nrow(listvessels))
#test area
#listids<-listvessels%>%pull(`Vessel ID`)
#aa<-gfw_vessel_info(search_type="id",ids=listids[1])
```
 
# Exploring gw AIS data for the SA EEZ

Basic stuff : counting elements, map if possible.

```{r xplore,eval=T}

#check the nb of lines by year/month
dbpath<-here("data","raw","ais","gfw","parquet","gfw_ais_presence")
ds<-open_dataset(dbpath)
basictable<-ds%>%group_by(year,month)%>%summarise(position_nb=n())%>%collect()
basictable<-basictable%>%mutate(month=sprintf("%02d",month))%>%pivot_wider(names_from=year,values_from=position_nb)%>%arrange(month)
kable(basictable)

#stat on vessel, flag etc
listvessels<-ds%>%group_by(`Vessel ID`,`Flag`,`Vessel Name`,`Gear Type`,`Vessel Type`,MMSI,IMO,CallSign,year)%>%summarise(n=n())%>%collect()
vesseltable<-listvessels%>%
	group_by(`Vessel Type`,year)%>%
	summarise(position_nb=sum(n))%>%
	pivot_wider(names_from=year,values_from=position_nb)
kable(vesseltable)

#an exemple of a vessel track
onevessel<-ds%>%filter(MMSI==601713000)%>%arrange(`Time Range`)%>%collect()
p1  <- ggplot() +
    geom_path(data = onevessel, aes(x = Lon, y = Lat,color=month), alpha = 0.7)+
    facet_wrap(~year)+
    theme_bw()+xlab("Longitude")+ylab("Latitude")
print(p1)

#trying to plot everything for one year : doable / memory dependent
oneyearvessel<-ds%>%filter(year==2024)%>%arrange(`Vessel ID`,`Time Range`)%>%collect()
p2  <- ggplot() +
    geom_scattermore(data = oneyearvessel, aes(x = Lon, y = Lat,color=month), alpha = 0.7)+
    facet_wrap(~`Vessel Type`)+
    theme_bw()+xlab("Longitude")+ylab("Latitude")+ggtitle("2024")
print(p2)


```

# Summary of gfw AIS data around some position

Extracting AIS info around a point, so in a disk.


```{r buffering}
#function to generate a disk around a position based on a radius (in degrees)
dobuf<-function(x=26.29143,y=-33.89823,radius=10000){
	#Bird Island Algoa Bay 10km as default parameters (dist in m if sf_use_s2() true)
	p1<-st_as_sf(data.frame(x,y),coords=c("x","y"),crs = st_crs(4326))
	d1<-sf::st_buffer(p1,dist=radius)
	return(d1)
}
buf<-dobuf()
xylim<-st_bbox(buf)
xlim0<-c(xylim[1],xylim[3])
ylim0<-c(xylim[2],xylim[4])
xlimext<-c(xylim[1]-1,xylim[3]+1)#add 1 degre around the disk to help representation
ylimext<-c(xylim[2]-1,xylim[4]+1)
#positionning the disk in geographical space
m1<-ggplot()+
	geom_sf(data=buf,col="red",fill=NA)+
	annotation_borders(fill="grey",colour=NA,alpha=.5)+
	coord_sf(xlim=xlimext,ylim=ylimext)+
	theme_bw()
print(m1)


#extracting info from ais_presence in the area of interest
dbpath<-here("data","raw","ais","gfw","parquet","gfw_ais_presence")
ds<-open_dataset(dbpath)
dat1<-ds%>%filter(xlimext[1]<=Lon,Lon<=xlimext[2],ylimext[1]<=Lat,Lat<=ylimext[2])%>%
	collect()
#plot it raw
m2  <- ggplot() +
	geom_scattermore(data = dat1, aes(x = Lon, y = Lat,color=`Vessel Type`), alpha = 0.7)+
    geom_sf(data=buf,col="red",fill=NA)+
    facet_wrap(~year)+
    theme_bw()+xlab("Longitude")+ylab("Latitude")+ggtitle("2024")
print(m2) #ugly

#compute monthly time of nb of position by vessel type strickly inside the buffer
tspos1<-dat1%>%
	filter(xlim0[1]<=Lon,Lon<=xlim0[2],ylim0[1]<=Lat,Lat<=ylim0[2])%>%
	group_by(month,year,`Vessel Type`)%>%
	summarise(nb_pos=n())%>%
	ungroup()%>%
	mutate(timeid=ym(paste(year,"-",sprintf("%02d",month))))%>%
	arrange(`Vessel Type`,timeid)

pts1<-ggplot()+
	geom_path(data=tspos1,aes(x=timeid,y=nb_pos))+
	facet_wrap(~`Vessel Type`,scale="free")+
        theme_bw()+xlab("Month")+ylab("Total number of hourly AIS position")+
	ggtitle("AIS GFW maritime traffic around Bird Island (10 km buffer)")
print(pts1)





```


# Session info

```{r}
sessionInfo()
```

